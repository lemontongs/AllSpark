<!DOCTYPE html>
<html>
    <!--
    
    Current string args:
        1: Table of user data           (string)
        2: Table of furnace data        (string)
        3: Average temperature          (float)
        4: Main current temperature     (float)
        5: Main current set point       (float)
        6: Top current temperature      (float)
        7: Top current set point        (float)
        8: Basement current temperature (float)
        9: Basement current set point   (float)
       10: Is someone home?             (string)
    
    -->
    <head>
        <script type="text/javascript" src="../jquery.min.js"></script>
        <script type="text/javascript" src="../jquery.bootstrap-touchspin.min.js"></script>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">
            
            google.load("visualization", "1", {packages:["corechart","timeline"]});
            
            function updateSetPoint(device)
            {
                var set_point = $("input[name='"+device+"']").val()
                
                $.get("cgi-bin/set_temp.py?set_temp="+set_point+"&floor="+device, function (result)
                { 
                    if (result.trim() == "OK")
                    {
                        $("button[name='"+device+"_btn']").toggleClass('btn-primary');
                        $("button[name='"+device+"_btn']").toggleClass('btn-success');
                        setTimeout(function()
                        {
                            $("button[name='"+device+"_btn']").toggleClass('btn-success');
                            $("button[name='"+device+"_btn']").toggleClass('btn-primary');
                        }, 5000);
                    }
                    else
                    {
                        $("button[name='"+device+"_btn']").toggleClass('btn-primary');
                        $("button[name='"+device+"_btn']").toggleClass('btn-danger');
                        alert(result);
                        setTimeout(function()
                        {
                            $("button[name='"+device+"_btn']").toggleClass('btn-danger');
                            $("button[name='"+device+"_btn']").toggleClass('btn-primary');
                        }, 5000);
                    }
                });
            }
            
            function drawTempData(data)
            {
                var rows = data.split("\n");
                
                var result = [['Time', 'Top Floor', 'Main Floor', 'Basement']];
                
                for ( var i = 0; i < rows.length; i++)
                {
                    var row = rows[i];
                    var items = row.split(",");
                    if (items.length != 4)
                        continue;
                    
                    var time = items[0];
                    
                    var d = new Date(0); // The 0 there is the key, which sets the date to the epoch
                    d.setUTCSeconds(parseInt(time));
                    
                    var now = new Date();
                    var days = (now - d)/(1000*60*60*24);
                    if (days > 1.0)
                    {
                        continue;
                    }
                    
                    var temps = [];
                    temps.push(d);
                    for (var t = 1; t < items.length; t++ )
                    {
                        temps[t] = parseFloat(items[t]);
                        if (temps[t] == NaN)
                        {
                            temps[t] = null;
                        }
                    }
                    
                    result.push(temps);
                }
                
                var data = google.visualization.arrayToDataTable(result);
                var options = { title: 'Zone Temperatures (F)' };//,
                             //   hAxis: { showTextEvery: Math.floor(data.getNumberOfRows() / 5) } };

                var chart = new google.visualization.LineChart(document.getElementById('temp_chart_div'));
                chart.draw(data, options);
            }
            
            function drawMemData(data)
            {
                var rows = data.split("\n");
                
                var result = [['Time','Memory Usage (percent)']];
                
                for ( var i = 0; i < rows.length; i++)
                {
                    var row = rows[i];
                    var items = row.split(",");
                    if (items.length != 2)
                        continue;
                    var time = items[0];
                    var mem_usage = items[1];
                    
                    var d = new Date(0); // The 0 there is the key, which sets the date to the epoch
                    d.setUTCSeconds(parseInt(time));
                    
                    var now = new Date();
                    var days = (now - d)/(1000*60*60*24);
                    if (days > 1.0)
                    {
                        continue;
                    }
                    
                    result.push([d, parseFloat(mem_usage)]);
                }
                
                var data = google.visualization.arrayToDataTable(result);
                var options = { title: 'Memory Usage' };
                var chart = new google.visualization.LineChart(document.getElementById('mem_chart_div'));
                chart.draw(data, options);
            }
            
            function drawUserData() {
                var dataTable = new google.visualization.DataTable();

                dataTable.addColumn({ type: 'string', id: 'User' });
                dataTable.addColumn({ type: 'date', id: 'Start' });
                dataTable.addColumn({ type: 'date', id: 'End' });

                dataTable.addRows([
                  
                %s                                                                                   //   USER IS HOME DATA

                ]);

                chart = new google.visualization.Timeline(document.getElementById('user_chart_div'));
                chart.draw(dataTable);
            }
            
            function drawFurnaceData() {
                var dataTable = new google.visualization.DataTable();

                dataTable.addColumn({ type: 'string', id: 'Zone' });
                dataTable.addColumn({ type: 'date', id: 'Start' });
                dataTable.addColumn({ type: 'date', id: 'End' });

                dataTable.addRows([
                  
                %s                                                                                   //   FURNACE IS ON DATA

                ]);

                chart = new google.visualization.Timeline(document.getElementById('furnace_chart_div'));
                chart.draw(dataTable);
            }
            
            
            $(document).ready(function () {
                $.get("floor_temps.csv", function (data) { drawTempData(data); });
                $.get("mem_usage.csv",   function (data) { drawMemData(data); });
                drawUserData();
                drawFurnaceData();
            });
            
        </script>
    </head>
    <body>
        
        <div class="container">
        
            <div class="header">
                <!--ul class="nav nav-pills pull-right">
                    <li class="active"><a href="#">Thermostat</a></li>
                </ul-->
                <h3 class="text-muted">Home Control</h3>
            </div>

            <div class="jumbotron">
                <h2>Thermostat</h2>
                <p class="lead">Current average temperature is: %.1f F</p>                             <!-- CURR AVERAGE TEMP -->
                <div class="row">
                     <div class="col-md-12">
                        <div id="temp_chart_div" style="height: 500px;"></div>
                     </div>
                </div>
                <br>
                <div class="row">
                    <div class="col-md-4">
                        <p>Top floor is: %.1f F</p>                                                   <!-- TOP FLOOR CURR TEMP -->
                    </div>
                    <div class="col-md-2">
                        <p>Set point: </p>
                    </div>
                    <div class="col-md-4">
                        <input name="top_floor_temp" type="text" value="%s">                    <!-- TOP FLOOR SET POINT -->
                        <script>
                        $("input[name='top_floor_temp']").TouchSpin({
                            min: 50,
                            max: 80,
                            step: 0.5,
                            decimals: 2,
                            boostat: 5,
                            maxboostedstep: 10,
                            postfix: 'F'
                        });
                        </script>
                    </div>
                    <div class="col-md-2">
                        <button type="button" name="top_floor_temp_btn" class="btn btn-primary" onclick="updateSetPoint('top_floor_temp')">Submit</button>
                    </div>
                </div>
                <br>
                <div class="row">
                    <div class="col-md-4">
                        <p>Main floor is: %.1f F</p>                                                   <!-- MAIN FLOOR CURR TEMP -->
                    </div>
                    <div class="col-md-2">
                        <p>Set point: </p>
                    </div>
                    <div class="col-md-4">
                        <input name="main_floor_temp" type="text" value="%s">                    <!-- MAIN FLOOR SET POINT -->
                        <script>
                        $("input[name='main_floor_temp']").TouchSpin({
                            min: 50,
                            max: 80,
                            step: 0.5,
                            decimals: 2,
                            boostat: 5,
                            maxboostedstep: 10,
                            postfix: 'F'
                        });
                        </script>
                    </div>
                    <div class="col-md-2">
                        <button type="button" name="main_floor_temp_btn" class="btn btn-primary" onclick="updateSetPoint('main_floor_temp')">Submit</button>
                    </div>
                </div>
                <br>
                <div class="row">
                    <div class="col-md-4">
                        <p>Basement is: %.1f F</p>                                                      <!-- BASEMENT CURR TEMP -->
                    </div>
                    <div class="col-md-2">
                        <p>Set point: </p>
                    </div>
                    <div class="col-md-4">
                        <input name="basement_floor_temp" type="text" value="%s">                 <!-- BASEMENT SET POINT -->
                        <script>
                        $("input[name='basement_floor_temp']").TouchSpin({
                            min: 50,
                            max: 80,
                            step: 0.5,
                            decimals: 2,
                            boostat: 5,
                            maxboostedstep: 10,
                            postfix: 'F'
                        });
                        </script>
                    </div>
                    <div class="col-md-2">
                        <button type="button" name="basement_floor_temp_btn" class="btn btn-primary" onclick="updateSetPoint('basement_floor_temp')">Submit</button>
                    </div>
                </div>
                <div class="row">
                    <h2>Furnace State:</h2>
                    <div class="col-md-12">
                        <div id="furnace_chart_div"></div>
                    </div>
                </div>
            </div>

            <div class="jumbotron">
                <h2>Users</h2>
                <p class="lead">Someone is home: %s</p>                                                   <!-- SOMEONE IS HOME -->
                <div id="user_chart_div"></div>
            </div>

            <div class="jumbotron">
                <h2>Memory Usage</h2>
                <div id="mem_chart_div"></div>
            </div>

            <div class="footer">
                <p>&copy; Lemontongs 2014</p>
            </div>

        </div> <!-- /container -->
        
        <link href="../bootstrap.min.css" rel="stylesheet"/>
        <link href="../jquery.bootstrap-touchspin.min.css" rel="stylesheet"/>
    </body>
</html>
